# Services Architecture - Cartos RESP 2025

## Service Registry Pattern

### MapRegistry System
Central registry managing available map services:

**Registration Process:**
- Services register with unique ID, MapService instance, and renderer function
- Registry provides discovery methods (get, getAll, getIds)
- Type-safe MapServiceEntry interface ensures consistency

**Service Lifecycle:**
1. Service registration during app initialization
2. Service discovery through registry queries
3. Service instantiation and data loading on demand
4. Service state management through store

## MapService Base Class

### Core Functionality
Abstract service class providing:
- CSV data loading via D3
- Form control configuration management (FormControl[])
- Selected form controls state tracking
- Filtered data computation based on selections

### Data Filtering Logic
The filteredData getter supports multiple data formats:
- Couverture data: filters by "Libelle" column matching facility selection
- Duree data: filters by "Source" column matching facility selection  
- Eloignement/Evolution data: uses same filtering pattern as other services
- Fallback: returns unfiltered data for unknown formats

### Form Control Management
- formControls array stores FormControl objects with key, name, and entries properties
- selectedFormControls Map tracks current user choices by control key
- Default selections initialize from first available entry in each FormControl
- FormControl structure provides user-friendly display names and organized entry groups

### FormControl Structure
Each service defines formControls as an array of FormControl objects:

**FormControl Interface:**
- key: Unique identifier for the control (e.g., 'metric', 'facility')
- name: User-friendly display name (e.g., 'Indicateur', 'Service', 'Temps d\'accès')
- entries: Array of InputEntry objects with label and key properties

**Standard Control Types:**
- metric: Defines available data metrics for visualization
- facility: Defines available facilities or services to filter by
- Custom controls: Services can define specialized control types

**Display Names by Service:**
- Standard: 'Indicateur' for metrics, 'Service' for facilities
- Eloignement: 'Temps d\'accès' for time-based metric controls

## Service Implementations

### Couverture Service
**Data Source:** `/data/couverture.csv`
**Title:** "Couverture des équipements et services"
**Metrics:** Population coverage percentage, commune equipment percentage
**Facilities:** 33 facility types (airports, postal services, healthcare, education)
**Renderer:** renderCouvertureMap with blue/purple color schemes

### Duree Service  
**Data Source:** `/data/duree.csv`
**Title:** "Durées d'accès aux équipements ou services publics"
**Metrics:** Median duration, average duration (in minutes)
**Facilities:** 30 facility types matching couverture categories
**Renderer:** renderDureeMap with red/orange color schemes

### Eloignement Service
**Data Source:** `/data/eloignement.csv`
**Title:** "Éloignements des populations aux équipements ou services publics"
**Metrics:** Time thresholds (5, 10, 15, 20, 30, 45, 60 minutes)
**Facilities:** 30 facility types plus "panier (ensemble)" composite metric
**Renderer:** renderEloignementMap with distance-based color schemes

### Evolution Service
**Data Source:** `/data/evolution.csv`
**Title:** "Évolution du maillage des équipements ou services publics entre 2019 et 2024"
**Metrics:** Evolution percentage, evolution count (2019-2024 change)
**Facilities:** 10 facility types focusing on key public services
**Renderer:** renderEvolutionMap with diverging color schemes for change visualization

## Renderer Architecture

### Generic Choropleth System
Both services use renderChoropleth with service-specific configurations:

**Common Parameters:**
- plotTitle: Dynamic title based on selections
- tabularData: Filtered service data
- featureCollection: Geographic boundaries
- colorScale: Service-specific color schemes and legends

**Data Mapping:**
- featureKey: Extracts department codes from geographic features
- rowKey: Extracts department codes from tabular data
- valueAccessor: Retrieves metric values for visualization
- numberNormalizer: Handles decimal formatting (comma to dot)

### Visualization Differences
**Couverture Maps:**
- Percentage-based color scales with quantize type
- Blue scheme for population coverage, purple for commune equipment
- Dual-metric tooltips showing both coverage types

**Duree Maps:**
- Time-based color scales for duration visualization
- Orange scheme for median duration, red for average duration
- Tooltips with time formatting and duration context

**Eloignement Maps:**
- Distance threshold visualization with appropriate color schemes
- Time-based metrics showing population accessibility
- Facility-specific color palettes

**Evolution Maps:**
- Diverging color schemes for change visualization
- Percentage vs count change options
- Historical comparison tooltips (2019-2024)